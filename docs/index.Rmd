---
title: "Trabalho em desenvolvimento."
author: "Beatriz Milz e Rosana Laura"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```
##  Disciplina: CTA-106 - Uso de dados espaciais para estudos ambientais


## Carregar os pacotes necessários:

```{r message=FALSE, warning=FALSE}
# install.packages("rgdal")
library(rgdal)

# install.packages("sf")
library(sf)

# install.packages("tmap")
library(tmap)

library(tidyverse)
library(lubridate)
```

## Carregar os dados de outorga
```{r}
outorgas_ANA_estadual_2016 <- read_sf("data/vetor/Outorgas-UF-ESTA-SP-2016-1/Outorgas UF ESTA SP 2016.shp")
outorgas_ANA_federal_2018 <- read_sf("data/vetor/Outorgas-ANA-EST-SP-2018-1/Outorgas ANA EST SP 2018.shp")
```


## Verificar as projeções
```{r}
st_crs(outorgas_ANA_estadual_2016)
plot(Latitude ~Longitude, data=outorgas_ANA_estadual_2016)

st_crs(outorgas_ANA_federal_2018)
plot(Latitude ~Longitude, data=outorgas_ANA_federal_2018)


```

## Adequar as projeções para SIRGAS 2000
```{r}
EPSG <- make_EPSG()
#sirgas2000 <- as.character(subset(EPSG, code==4674))

outorgas_ANA_estadual_2016_sf <- st_as_sf(outorgas_ANA_estadual_2016, coords = c("Longitude", "Latitude"), crs = 4674)

st_crs(outorgas_ANA_estadual_2016_sf)<-4674
st_crs(outorgas_ANA_estadual_2016_sf)
plot(Latitude ~Longitude, data=outorgas_ANA_estadual_2016_sf)



outorgas_ANA_federal_2018_sf <- st_as_sf(outorgas_ANA_federal_2018, coords = c("Longitude", "Latitude"), crs = 4674)

st_crs(outorgas_ANA_federal_2018_sf)<-4674
st_crs(outorgas_ANA_federal_2018_sf)
plot(Latitude ~Longitude, data=outorgas_ANA_federal_2018_sf)
```

## Carregar o polígono da Macrometrópole e adequar a projeção para SIRGAS 2000
```{r}
MMP_Emplasa <- read_sf("data/vetor/LimiteMacrometropole2015/LimiteMacrometropole2015Polygon.shp")
st_crs(MMP_Emplasa)
st_crs(outorgas_ANA_federal_2018_sf)<-4674
plot(st_geometry(MMP_Emplasa))
```


## Selecionar apenas outorgas no território da Macrometrópole Paulista
```{r}

outorgas_MMP_fed_2018 <- outorgas_ANA_federal_2018_sf[MMP_Emplasa, ]

outorgas_MMP_est_2016 <- outorgas_ANA_estadual_2016_sf[MMP_Emplasa, ]
```



## Primeira visualização de dados

```{r message=FALSE, warning=FALSE}

 tm_shape(MMP_Emplasa) + tm_polygons()+
   tm_grid(alpha = 0.2, labels.rot = c(0,90), labels.inside.frame = FALSE) +
     tm_add_legend(type = "line", col = "gray30", labels = "Macrometrópole Paulista") +
    tm_shape(outorgas_MMP_fed_2018) + tm_bubbles(size = "m3_s", col = "blue")+

   tm_shape(outorgas_MMP_est_2016) + tm_bubbles(size = "m3_s", col = "red" )+
  tm_scale_bar(position = c("right","top")) +
   tm_compass(position = c("left","top")) + 
   tm_credits(" Projecao SIRGAS 2000 \n Fonte: DATAGEO, SEADE", position = c("right","bottom")) +
 tm_layout(main.title = "Outorgas de Recursos Hídricos \n na Macrometrópole Paulista", main.title.position = "center", outer.margins = 0.05)

```



## Filtrando outorgas vigentes (de 01 de março de 2019 em diante)
```{r}

outorgas_MMP_fed_2018_v <- outorgas_MMP_fed_2018 %>% filter(Validade >= as.Date("2019-03-01"))

outorgas_MMP_est_2016_v <- outorgas_MMP_est_2016 %>% filter(Validade >= as.Date("2019-03-01"))

```


```{r message=FALSE, warning=FALSE}

 tm_shape(MMP_Emplasa) + tm_polygons()+
   tm_grid(alpha = 0.2, labels.rot = c(0,90), labels.inside.frame = FALSE) +
     tm_add_legend(type = "line", col = "gray30", labels = "Macrometrópole Paulista") +
    tm_shape(outorgas_MMP_fed_2018_v) + tm_bubbles(size = "m3_s", col = "blue")+

   tm_shape(outorgas_MMP_est_2016_v) + tm_bubbles(size = "m3_s", col = "red" )+
  tm_scale_bar(position = c("right","top")) +
   tm_compass(position = c("left","top")) + 
   tm_credits(" Projecao SIRGAS 2000 \n Fonte: DATAGEO, SEADE", position = c("right","bottom")) +
 tm_layout(main.title = "Outorgas de Recursos Hídricos vigentes \n na Macrometrópole Paulista", main.title.position = "center", outer.margins = 0.05)

```

```{r}
 tm_shape(MMP_Emplasa) + tm_polygons()+
   tm_grid(alpha = 0.2, labels.rot = c(0,90), labels.inside.frame = FALSE) +
     tm_add_legend(type = "line", col = "gray30", labels = "Macrometrópole Paulista") +
    tm_shape(outorgas_MMP_fed_2018_v) + tm_bubbles(size = "m3_s", col = "Finalidade")+
  tm_scale_bar(position = c("right","top")) +
   tm_compass(position = c("left","top")) + 
   tm_credits(" Projecao SIRGAS 2000 \n Fonte: DATAGEO, SEADE", position = c("right","bottom")) +
 tm_layout(main.title = "Outorgas de Recursos Hídricos vigentes \n na Macrometrópole Paulista - Federal", main.title.position = "center", outer.margins = 0.05, legend.outside = TRUE)
 
 
```




```{r}
  tm_shape(MMP_Emplasa) + tm_polygons()+
   tm_grid(alpha = 0.2, labels.rot = c(0,90), labels.inside.frame = FALSE) +
     tm_add_legend(type = "line", col = "gray30", labels = "Macrometrópole Paulista") +
       tm_shape(outorgas_MMP_est_2016_v) + tm_bubbles(size = "m3_s", col = "grey40")+
  tm_scale_bar(position = c("right","top")) +
   tm_compass(position = c("left","top")) + 
   tm_credits(" Projecao SIRGAS 2000 \n Fonte: DATAGEO, SEADE", position = c("right","bottom")) +
 tm_layout(main.title = "Outorgas de Recursos Hídricos vigentes \n na Macrometrópole Paulista - Estadual", main.title.position = "center", outer.margins = 0.05, legend.outside = TRUE)
```

